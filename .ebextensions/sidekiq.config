commands:
  create_post_dir:
    command: "mkdir /opt/elasticbeanstalk/hooks/appdeploy/post"
    ignoreErrors: true
files:
  "/etc/rsyslog.d/sidekiq.conf":
    mode: '000644'
    content: |
      EB_CONFIG_APP_LOGS=$(/opt/elasticbeanstalk/bin/get-config container -k app_log_dir)
      
      $InputFileName $EB_CONFIG_APP_LOGS/sidekiq.log
      $InputFileTag sidekiq
      $InputFileStateFile sidekiq-state
      $InputFileSeverity info
      $InputFileFacility local6
      $InputRunFileMonitor
   
    "/opt/elasticbeanstalk/hooks/appdeploy/post/50_restart_sidekiq":
      mode: "000777"
      owner: root
      group: root
      content: |
        EB_SCRIPT_DIR=$(/opt/elasticbeanstalk/bin/get-config container -k script_dir)
        EB_APP_STAGING_DIR=$(/opt/elasticbeanstalk/bin/get-config container -k app_staging_dir)
        EB_CONFIG_APP_CURRENT=$(/opt/elasticbeanstalk/bin/get-config container -k app_deploy_dir)
        EB_CONFIG_APP_LOGS=$(/opt/elasticbeanstalk/bin/get-config container -k app_log_dir)
        EB_APP_USER=$(/opt/elasticbeanstalk/bin/get-config container -k app_user)
        EB_SUPPORT_DIR=$(/opt/elasticbeanstalk/bin/get-config container -k support_dir)
        EB_CONFIG_APP_PIDS=$(/opt/elasticbeanstalk/bin/get-config container -k app_pid_dir)
   
        . $EB_SUPPORT_DIR/envvars
        . $EB_SCRIPT_DIR/use-app-ruby.sh
   
        cd EB_CONFIG_APP_CURRENT
   
        if [ -f EB_CONFIG_APP_PIDS/sidekiq.pid ]
        then
          kill -TERM `cat $EB_CONFIG_APP_PIDS/sidekiq.pid`
          rm -rf EB_CONFIG_APP_PIDS/sidekiq.pid
        fi
   
        . EB_SUPPORT_DIR/envvars.d/sysenv
   
        sleep 10
   
        bundle exec sidekiq \
          -P EB_CONFIG_APP_PIDS/sidekiq.pid \
          -C EB_CONFIG_APP_CURRENT/config/sidekiq.yml \
          -L EB_CONFIG_APP_LOGS/sidekiq.log \
          -d
   
    "/opt/elasticbeanstalk/hooks/appdeploy/pre/03_mute_sidekiq":
      mode: "000777"
      content: |
        EB_CONFIG_APP_PIDS=$(/opt/elasticbeanstalk/bin/get-config container -k app_pid_dir)
        
        if [ -f EB_CONFIG_APP_PIDS/sidekiq.pid ]
        then
          kill -USR1 `cat $EB_CONFIG_APP_PIDS/pids/sidekiq.pid`
          rm -rf EB_CONFIG_APP_PIDS/sidekiq.pid
        fi